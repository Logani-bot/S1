# 📊 S1 & S12 시스템 전체 작동 방식 요약 정리

## 🎯 시스템 개요

두 개의 독립적인 트레이딩 시스템이 24/7로 자동 실행됩니다:

### S1 시스템 (시가총액 기반)
- **유니버스**: 시가총액 1조 3천억원 이상 종목
- **기준 파일**: `output/marketcap_universe.xlsx`
- **신호 파일**: `output/trading_signals_s1.xlsx`
- **알림 접두사**: `[S1]`

### S12 시스템 (거래대금 기반)
- **유니버스**: 거래대금 상위 종목
- **기준 파일**: `output/turnover_universe.xlsx`
- **신호 파일**: `output/trading_signals.xlsx`
- **알림 접두사**: `[S12]` (또는 기본값)

---

## 📅 일일 자동 실행 스케줄

### S1 시스템 일일 작업 (매일 20:15)
```
20:15 → S1_Daily_Trading_Signal 실행
  ↓
1. Daily_MarketCap_Tracker.py
   - 시가총액 1조 3천억원 이상 종목 수집
   - 키움 API (ka10099) 사용
   - output/marketcap_universe.xlsx 생성
  ↓
2. Trading_Signal_System_S1.py
   - marketcap_universe.xlsx 분석
   - 20일 이동평균선 계산
   - 엔벨로프(-20%) 지지선 계산
   - 3단계 매수선/매도선 계산
   - output/trading_signals_s1.xlsx 생성
  ↓
완료 → 텔레그램 일일 리포트 발송
```

### S12 시스템 일일 작업 (매일 20:10)
```
20:10 → S2_Daily_Trading_Signal 실행
  ↓
1. Daily_Turnover_Tracker.py
   - 거래대금 상위 종목 수집
   - output/turnover_universe.xlsx 생성
  ↓
2. Trading_Signal_System.py
   - turnover_universe.xlsx 분석
   - 매매 신호 생성
   - output/trading_signals.xlsx 생성
  ↓
완료 → 텔레그램 일일 리포트 발송
```

---

## 🔍 실시간 모니터링 작동 방식

### S1 실시간 모니터링 (평일 08:00)
```
08:00 → S1_Realtime_Monitor 실행 (Windows 작업 스케줄러)
  ↓
거래일 체크
  - 주말/공휴일 → 스킵, 다음 거래일까지 대기
  - 거래일 → 계속 진행
  ↓
모니터링 루프 시작 (08:00-20:00)
  ↓
각 사이클 (60초 간격):
  1. Excel에서 Summary 탭 종목 로드
     - output/trading_signals_s1.xlsx의 Summary 시트
     - 티커, 종목명, 매수상태, 1차/2차/3차 매수선 정보
  2. 각 종목별 현재가 조회 (키움 API)
  3. 저가 기준 매수선 접근 체크
     - 매수선 도달 (저가 ≤ 매수선) → 체결 알림
     - 매수선 1% 이내 → 긴급 알림
     - 매수선 3% 이내 → 주의 알림
     - 매수선 5% 이내 → 예비 알림
  4. 텔레그램 알림 전송 (조건 충족 시)
  5. 알림 히스토리 기록 (중복 방지)
  6. 60초 대기 후 다음 사이클
  ↓
20:00 → 모니터링 종료
  ↓
다음 거래일 08:00 자동 재시작
```

### S12 실시간 모니터링 (평일 08:00)
```
08:00 → S2_Realtime_Monitor 실행 (Windows 작업 스케줄러)
  ↓
거래일 체크
  ↓
모니터링 루프 시작 (08:00-20:00)
  ↓
각 사이클 (60초 간격):
  1. Excel에서 Summary 탭 종목 로드
  2. 각 종목별 현재가 조회
  3. 매수선 접근 체크
  4. 텔레그램 알림 전송
  5. 알림 히스토리 기록
  6. 60초 대기 후 다음 사이클
  ↓
20:00 → 모니터링 종료
```

---

## 🔔 알림 시스템

### 알림 종류

#### 1. 일일 리포트 (매일 20:10/20:15)
- **발송 시간**: 일일 작업 완료 후
- **내용**: 접근 중인 종목 요약
- **중복**: 하루 1회

#### 2. 실시간 알림 (거래일 08:00-20:00)
- **체결 알림**: 매수선 도달 시 즉시 전송
- **접근 알림**: 
  - 1% 이내: 긴급 (🔴)
  - 3% 이내: 주의 (🟠)
  - 5% 이내: 예비 (🟡)
- **중복 방지**: 같은 종목 같은 상태는 하루 1회

### 알림 전송 조건
- **저가 기준**: 당일 저가가 매수선에 접근한 경우
- **상태별**: 
  - NONE → 1차 매수선 체크
  - BOUGHT_1 → 2차 매수선 체크
  - BOUGHT_2 → 3차 매수선 체크

---

## 📂 파일 구조

### S1 시스템 파일 구조
```
S1/
├── Daily_MarketCap_Tracker.py          # 시가총액 유니버스 수집
├── Trading_Signal_System_S1.py        # 매매 신호 생성
├── Real_Time_Monitor_S1.py             # 실시간 모니터링
├── RUN_S1_DAILY.bat                     # 일일 작업 실행
├── run_s1_realtime.bat                  # 실시간 모니터링 실행
├── setup_windows_scheduler_s1.ps1      # 스케줄러 자동 설정
├── output/
│   ├── marketcap_universe.xlsx         # 시가총액 유니버스
│   └── trading_signals_s1.xlsx         # 매매 신호 (Summary 탭 포함)
├── logs/                                # 로그 파일
└── alert_history.json                   # 알림 히스토리
```

### S12 시스템 파일 구조
```
S12/
├── Daily_Turnover_Tracker.py            # 거래대금 유니버스 수집
├── Trading_Signal_System.py             # 매매 신호 생성
├── Real_Time_Monitor.py                 # 실시간 모니터링
├── RUN_DAILY_SYSTEM.bat                 # 일일 작업 실행
├── run_real_time_monitor.bat            # 실시간 모니터링 실행
├── setup_windows_scheduler.ps1          # 스케줄러 자동 설정
├── output/
│   ├── turnover_universe.xlsx           # 거래대금 유니버스
│   └── trading_signals.xlsx             # 매매 신호 (Summary 탭 포함)
└── logs/                                # 로그 파일
```

---

## ⚙️ 자동 실행 메커니즘

### Windows 작업 스케줄러 설정

#### S1 작업 목록
1. **S1_Daily_Trading_Signal**
   - 트리거: 매일 20:15
   - 작업: RUN_S1_DAILY.bat
   - 모드: 백그라운드 (숨김)

2. **S1_Realtime_Monitor**
   - 트리거: 평일 08:00
   - 작업: run_s1_realtime.bat
   - 모드: 표시 (화면에 표시)

#### S12 작업 목록
1. **S2_Daily_Trading_Signal**
   - 트리거: 매일 20:10
   - 작업: RUN_DAILY_SYSTEM.bat
   - 모드: 백그라운드 (숨김)

2. **S2_Realtime_Monitor**
   - 트리거: 평일 08:00
   - 작업: run_real_time_monitor.bat
   - 모드: 표시 (화면에 표시)

### 자동 재시작 기능
- ✅ **오류 시 자동 재시도**: 최대 3회, 1분 간격
- ✅ **배터리 모드 지원**: 절전 모드에서도 실행
- ✅ **작업 시작 가능 시 즉시 실행**: StartWhenAvailable
- ✅ **비거래일 자동 스킵**: 거래일 체크 후 스킵

---

## 🔄 전체 시스템 플로우

### 하루의 흐름

```
08:00 → S1 & S12 실시간 모니터링 시작
        (평일만, 거래일 체크)
        ↓
        [실시간 모니터링 루프]
        - 60초 간격 체크
        - 매수선 접근 감지
        - 텔레그램 알림 전송
        ↓
20:00 → 실시간 모니터링 종료
        ↓
20:10 → S12 일일 작업 시작
        - 거래대금 수집
        - 매매 신호 생성
        - 일일 리포트 발송
        ↓
20:15 → S1 일일 작업 시작
        - 시가총액 수집
        - 매매 신호 생성
        - 일일 리포트 발송
        ↓
다음날 08:00 → 반복
```

### 주간 흐름

```
월요일 08:00 → 모니터링 시작
화요일 ~ 금요일 → 계속 모니터링
토요일 ~ 일요일 → 자동 스킵
다음 월요일 08:00 → 자동 재시작
```

---

## 🛡️ 오류 처리 및 안정성

### 오류 처리 메커니즘
1. **API 오류**: 재시도 로직 내장
2. **파일 오류**: 로그 기록 후 계속 진행
3. **네트워크 오류**: 자동 재시도
4. **스케줄러 오류**: 최대 3회 자동 재시작

### 안정성 기능
- ✅ 거래일 자동 체크 (주말/공휴일 스킵)
- ✅ 모니터링 시간대 자동 체크 (08:00-20:00)
- ✅ 알림 중복 방지 (alert_history.json)
- ✅ 로그 파일 자동 기록
- ✅ 오류 발생 시 텔레그램 알림

---

## 📊 모니터링 포인트

### 종목 선택 기준
- **S1**: `output/trading_signals_s1.xlsx`의 **Summary 탭**만 모니터링
- **S12**: `output/trading_signals.xlsx`의 **Summary 탭**만 모니터링

### 매수선 접근 판단 기준
- **저가 기준**: 당일 저가가 매수선에 접근한 경우만 알림
- **이격도 계산**: `((저가 - 매수선) / 매수선) × 100`
- **체결 판단**: 저가 ≤ 매수선 (이격도 ≤ 0)

### 동적 모니터링 간격
- 매수선 1% 이내: 1분 간격 (실제로는 60초 고정)
- 매수선 3% 이내: 3분 간격
- 매수선 10% 이내: 10분 간격
- 매수선 10% 이상: 30분 간격
- **현재 구현**: 고정 60초 간격 (--interval 60)

---

## ✅ 완료 상태

### S1 시스템
- ✅ 24/7 자동 실행 설정 완료
- ✅ 일일 작업 스케줄러 등록 완료
- ✅ 실시간 모니터링 스케줄러 등록 완료
- ✅ 자동 재시작 설정 완료

### S12 시스템
- ✅ 24/7 자동 실행 설정 완료
- ✅ 일일 작업 스케줄러 등록 완료
- ✅ 실시간 모니터링 스케줄러 등록 완료
- ✅ 자동 재시작 설정 완료

---

## 🎉 최종 요약

**S1 & S12 시스템이 완전 자동화되어 24/7로 운영됩니다!**

- ✅ 매일 자동으로 유니버스 수집 및 신호 생성
- ✅ 평일 자동으로 실시간 모니터링
- ✅ 자동 오류 복구 및 재시작
- ✅ 텔레그램 알림으로 실시간 피드백
- ✅ 비거래일 자동 스킵
- ✅ 완전 자동화, 수동 개입 불필요

**시스템은 백그라운드에서 자동으로 실행되며, 텔레그램 알림만 받으면 됩니다!** 🚀

